name: List updates_files on pull request

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  anotherWayToListFiles:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - name: Glob match
        uses: tj-actions/glob@v16
        id: glob
        with:
          files: |
            modules/**
      - name: Run if file exist
        if: ${{ steps.glob.outputs.paths != ''}}
        uses: tj-actions/glob@v16
        id: glob-result-step
        with:
          files: |
            toto/**
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v34
        with:
          files: |
            modules/**
      - name: Get files url
        uses: actions/github-script@v6
        id: set-result
        env:
          FILES: ${{steps.changed-files.outputs.all_changed_files}}
          SITE_URL: 'http://localhost'
          COMPONENT_NAME: 'bonita'
        with:
          script: |            
            const script = require('./.github/github.js');
            return await script.prepareUrlLinks({github, context})
          result-encoding: string
      - name: Create or update comments
        uses: actions/github-script@v6
        env:
          LINKS: ${{steps.set-result.outputs.result}}
          RENAMED_FILES: ${{steps.changed-files.outputs.renamed_files}}
          HAS_DELETED_FILES: ${{steps.changed-files.outputs.any_deleted}}
        with:
          script: |
            let {LINKS, RENAMED_FILES, HAS_DELETED_FILES} = process.env;

            const HEADER=' ## :memo: Pull request files update\n\n';
            const preface =
            'In order to merge this pull request, you need to check your updates with the following url.\n\n';

            const availableLinks = `### :mag: Url to check: \n ${LINKS}\n\n\n\n`;

            //Adding deleted or renamed check
            let warningAliasMessage = '';
            if(HAS_DELETED_FILES === 'true' || RENAMED_FILES != ''){            
              warningAliasMessage='\n \n ### :warning: At least one file are deleted on this pull request, be sure to adding [alias](https://github.com/bonitasoft/bonita-documentation-site/blob/master/docs/content/CONTRIBUTING.adoc#use-alias-to-create-redirects)'
            }

            let body =  HEADER + preface + availableLinks + warningAliasMessage;
            const {data: comments} = await github.rest.issues.listComments({
                owner: context.repo.owner,
                issue_number: context.issue.number,
                repo: context.repo.repo,
            });

            for (const comment of comments) {
              if (comment.body?.startsWith(HEADER)) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  issue_number: context.issue.number,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
              };
            }

            await github.rest.issues.createComment({
             issue_number: context.issue.number,
             owner: context.repo.owner,
             repo: context.repo.repo,
             body: body
            })
          result-encoding: string

